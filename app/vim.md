いつも忘れるやつだけメモしておく

## vim 置き換え  
tag 置き換え replace

単発置き換え  
`:%s/before/after/`

ファイル全体置き換え  
`:%s/before/after/g`

範囲置き換え  
`:1,100s/before/after/g`

結果にマッチした文字列を含める 。複数利用する場合は "\1" "\2" "\3" となる模様。  
`:%s/\(before\)/\1/g`

最小一致、最短一致。 ０回以上マッチ  

	:\{-\}
	
	# エスケープは最初の一文字だけでも有効な模様。 gvim で確認。
	:\{-}
	
	# yyy から xxx までの最小一致。上記の最小一致を表す文字列の前に任意の文字に一致の "." を入れている。
	:yyy.\{-\}xxx


最小一致、最短一致。　１回以上マッチ  
`:\{-1,\}`

マッチした文字列を利用する  
`&` or `\(target\)` から `\1` で指定可能
1. `:%s/target/&/g`  
2. `:%s/\(target\)/\1/g`

1 の方が入力は簡単だが、2 の方が細かい指定が可能。

コマンドモード中にレジスタの文字を貼り付ける。直近を貼り付ける場合は 0  
`Ctrl + r + [0 - 9]`

多分区切り文字は統一されていれば / 以外でも可。

### 使いそうな正規表現

	# HTML のルビタグをひらがな表記のほうに置き換える。
	:%s/<ruby>.\{-}<rt>\(.\{-}\)<\/rt><\/ruby>/\1/g

	# HTML タグを全て消去
	:%s/<.\{-}>//g

## vim 制御文字入力
tag 制御コード

`Ctrl + V -> Ctrl + 制御コード`

Ctrl + V を押したあと Ctrl + 制御コードについている文字を入力する。
"^I" を入力する場合は以下

`Ctrl + V -> Ctrl + I`

## ウィンドウ操作
tag window

ウィンドウ分割。縦、横。  
`:vs or <C-w> s`  
`:sp or <C-w> v`

分割内のフォーカス移動   
`<C-w> h`  
`<C-w> j`  
`<C-w> k`  
`<C-w> l`  

分割ウィンドウの移動  
`<C-w> H`  
`<C-w> J`  
`<C-w> K`  
`<C-w> L`  

次のウィンドウ、前のウィンドウへ  
`<C-w> w`   
`<C-w> W`   

分割ウィンドウのサイズ変更  
`:resize 10`  
`<C-w> +`  
`<C-w> -`  
`<C-w> =`  

## スクロール操作

	カーソル行は移動しない。画面のみスクロールするコマンド。
	<C-e> １行分上にスクロール
	<C-y> １行分下にスクロール

## vimgrep

vim の使用中に grep コマンドを実行可能。角カッコ部分は任意入力。

    :vim[grep] pattern %

`%` はカレントバッファ（現在開いているファイル）を表す。  
ただし無名バッファ（保存していないファイル）を直接検索することはできない。

最低限のコマンドは上記の通りだが、パイプを使って下のコマンドも一緒に実行すると超便利。

    :vim[grep] pattern % | cw[indow]

grep の結果を新しいウィンドウに流し込んで表示。  
更にエンターキーでカーソル行の位置にジャンプできる。番号まで表示される親切振り。

検索結果が表示されるウィンドウは `Quickfix` という名前らしい。

## 以前の位置に戻る

カーソル位置の履歴を辿ることができる。一度ジャンプした後に元の場所に戻ってくる等の場面で有効。

| コマンド       | 動作         |
|------------|------------|
| Ctrl + o   | 直前の位置に戻る   |
| Ctrl + i   | 直後の位置に戻る   |

## 再選択

一度解除した選択範囲を再選択する。覚えておくと何かと短縮になる。  
g キーから始まる機能は他にも結構あるみたい。

	gv

## ディレクトリ移動
tag カレントディレクトリ, directory

現在のカレントディレクトリを移動する  
gvim の場合、path は普通にウィンドウズの形式でOK  
`:cd path`

現在のカレントディレクトリを開いているファイルの場所にセットする  
`:cd %:h`

上記をデフォルトにする。  
.vimrc に記述推奨  
`:set autochdir`

## 文字コード（エンコード）を指定する

	Shift JIS で指定  
	:edit ++encoding=sjis

	cp932 でも同様の意味？ 因みに cp はコードページの略らしい  
	:e ++enc=cp932

	UTF-8 で指定  
	:edit ++encoding=utf-8
	
## ファイルのエンコードを設定する

	:set fileencoding=sjis
	:set fenc=utf-8
	
++encoding={encoding} では、ファイルを指定した文字コードで開く(ファイルは変更しない)  
fileencoding={encoding} はファイルの文字コードを指定したコードに設定する（ファイルを変更する)  
わかりにくいが、役割が全く異なるコマンドとなっている。

## 現在のエンコードの確認
`:se enc?`  
`:se fenc?`

## ファイルの改行コードを確認する

	:set fileformat?
	:set ff?

	# 結果は以下のフォーマットで表示される。それぞれ右の改行コードに対応する

	fileformat=unix 	# LF
	fileformat=dos 		# CRLF
	fileformat=mac 		# CR

## ファイルの改行コードを表示する

	:set list		# 表示
	:set nolist		# 非表示

## ファイルの改行コードを変更する

	:set fileformat=dos
	:set ff=unix

	# 下記右の記号が改行コードとして表示される。
	
	# CR		\n		$
	# CRLF		\r\n	^M$
	# CR		\r		^M

`Windows` の `gVim` では `CRLF` は `$` で表示されてしまっているみたい。要検証。

指定できる改行コードは dos(CRLF), unix(LF), mac(CR) のいずれか。  
改行コードをセットしたらファイルは変更される。

## .vimrc の記述

	" .vimrc に追記すると、vim で使用する端末を bash に変更できる。(bash.exe が存在する前提)
	set shell=C:\PROGRA~1\Git\bin\bash.exe

### 端末に関して

Windows10 gvim で確認したところ、gvim を単体起動した場合の標準端末はコマンドプロンプト。  
また、gvim のコマンドモードから上記コマンドで端末をセットした場合は、上手く動作しない。  
.vimrc に記述して起動時から有効にしておく必要があるらしい。

Conemu から、gvim を起動した場合は上記のオプションがない場合でも bash が使用されていた。

## コマンドラインウィンドウ

キー入力 `q:` で開く。エディタ上と同じような操作感でコマンドを実行可能。  
過去に入力したコマンドが羅列される。実行したいコマンドの行にカーソルを合わせて `Enter` で実行。

	Ctrl + c

で履歴のコマンドを画面下のコマンドラインウィンドウに入力可能。

`:q` の入力で終了できる。


## 検索履歴

	q/
	q?
	
どちらかの入力で、過去の検索履歴をコマンドラインウィンドウのように表示できる。

## コマンド履歴

	:his

コマンドの履歴を確認できる。

## ウィンドウの端で折り返す

	:set wrap

折り返したくない場合は...

	:set nowrap

## .vimrc の設定

	" カーソルの上下移動を表示行での移動にする。
	nnoremap j gj
	nnoremap k gk

	" 開いたファイルのパスを作業ディレクトリに自動設定する
	set autochdir

## スクリプト

環境 : Windows gvim

vim で使用できるコマンドが書いてあるファイル。

`testScript.vim` のようなテキストファイルを作成すればそれがそのまま実行可能となる。

ファイル内には vim で使用するコマンドを : を書かずに記述する。

	echo "Hello world"

これを実行するには、vim を開き、カレントディレクトリを合わせた状態でコマンドを入力。

	# 普通に実行する
	:source testScript.vim

	# 現在開いているファイル（カレントバッファ）を実行する
	:source %

	# コマンドラインから実行する
	vim -S testScript.vim

vim で普段から使っているコマンドがそのまま利用可能。

## スクリプトサンプル

### HTML タグの置き換え

	" ルビタグの読み部分を削除して漢字表記のみにする
	%s:<ruby><rb>\(.\{-}\)</rb>.\{-}</ruby>:\1:g

	" すべての HTML タグを削除する
	:%s/<.\{-}>//g

## 別名で保存

	:saveas fileName
	:sav fileName

`:w fileName`  コマンドでも別名でファイルを保存できる。

`:saveas` は実行後、別名で保存した新しいファイルが開き直され編集する。

`:w` は古いファイルの編集をそのまま続ける。バックアップを作るような挙動となっている。

## 起動時にプラグインを読み込む

`.vimrc` に追記。パスのフォーマットは `Windows` 版でもスラッシュ区切りのフォーマットで問題なかった。

	set runtimepath+=~/vimfiles/plugin
	# ホームディレクトリの vimfiles/plugin の中のプラグインを全て読み込む

複数箇所から読み込みを行う場合は `,` で区切って表記する。  

	set runtimepath+=~/vimfiles/plugin,~/.vim/plugin

読み込みは左側から順に行われるらしい。  
プラグイン同士で依存関係を持つ場合以外は問題にならないと思われる。

## バッファ

vimがファイルを読み込んだ後にファイル内容をコピーするメモリ領域のこと。

一般的なエディタで言うところのタブとは異なるもののようだ。  
バッファにファイルを加えるには次のようにする。

	既に開いている `gvim` のウィンドウに新たなファイルをドラッグアンドドロップする。
	:e [fileName]	# バッファに対象ファイルを加える
	:new 			# 水平分割で新しいバッファ
	:vne			# 垂直分割で新しいバッファ

次のコマンドでバッファのリストを確認できる。

	:ls		# バッファに読み込まれているファイル一覧
	:ls!	# リストから消したファイルも含む一覧

リストに表示されているバッファは自由に切り替え可能。

	:bprev			# 一つ前のバッファに移動
	:bnext			# 一つ後のバッファに移動
	:bfirst			# 最初のバッファ（リスト先頭）に移動
	:blast			# 最後のバッファ（リスト末尾）に移動
	:b [Number]		# リストに表示されている番号を指定して移動する
	:[Number] b		# 同上
	:b [Name]		# バッファを特定できる文字列（名前）を指定して移動する

既定の状態では、未保存のバッファを切り替えようとすると警告が出る。  
このため、バッファを使用するにあたって、`.vimrc` には以下の追記が推重される。

	set hidden "未保存でもバッファの切替が可能になる。

別のバッファを分割で表示したい場合は一度で済ますことはできないみたい。

	:sp
	<C-w>l
	:b [number]

複数回コマンドを叩く必要がある。

## ノーマルコマンド

`:normal` に続いてノーマルモードでのキーを入力して実行すると、ノーマルモードでの操作を実行できる。

説明しにくいので具体例を挙げる。例えば次のコマンド。

    :normal jjj

と入力して実行すると、カーソルが３行分下に移動する。

入力内容が見えるし、逐一修正可能なので、意外とマクロよりも使い勝手が良い。

コマンドモードで最後に実行したコマンドは `@:` で繰り返し実行可能。

ノーマルモードでは `.` でも繰り返し実行できるが、間で削除とかすると動作が上書きされるため、`@:` がおすすめ。